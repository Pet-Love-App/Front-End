name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# åªè¿è¡Œæœ€æ–°çš„ PR æ£€æŸ¥
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ==================== PR ä¿¡æ¯æ£€æŸ¥ ====================
  pr-info:
    name: ğŸ“‹ PR Information
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
            build
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            PR æ ‡é¢˜å¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´
            ä¾‹å¦‚: "feat: Add dark mode support"

      - name: ğŸ“ Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            console.log(`ğŸ“Š PR Size: +${additions} -${deletions} (${total} total)`);

            if (total > 1000) {
              core.warning(`âš ï¸ Large PR detected (${total} lines). Consider splitting into smaller PRs.`);
            }

  # ==================== ä»£ç å®¡æŸ¥è¾…åŠ© ====================
  code-review:
    name: ğŸ¤– AI Code Review
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¤– Run AI Code Review
        uses: coderabbitai/ai-pr-reviewer@latest
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          debug: false
          review_simple_changes: false
          review_comment_lgtm: false

  # ==================== å˜æ›´å½±å“åˆ†æ ====================
  change-analysis:
    name: ğŸ“Š Change Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'src/app/**'
              - 'src/components/**'
              - 'src/design-system/**'
            backend:
              - 'src/lib/supabase/**'
              - 'src/services/**'
            tests:
              - '**/__tests__/**'
              - '**/_tests_/**'
              - '**/*.test.{ts,tsx}'
              - 'e2e/**'
            config:
              - '.github/**'
              - '*.config.{js,ts}'
              - 'tsconfig.json'
              - 'package.json'
            docs:
              - '**.md'
              - 'docs/**'

      - name: ğŸ’¬ Comment change summary
        uses: actions/github-script@v7
        with:
          script: |
            const changes = {
              frontend: ${{ steps.changes.outputs.frontend }},
              backend: ${{ steps.changes.outputs.backend }},
              tests: ${{ steps.changes.outputs.tests }},
              config: ${{ steps.changes.outputs.config }},
              docs: ${{ steps.changes.outputs.docs }}
            };

            const changedAreas = Object.entries(changes)
              .filter(([_, changed]) => changed === 'true')
              .map(([area]) => area);

            if (changedAreas.length === 0) {
              console.log('No significant changes detected');
              return;
            }

            const comment = `## ğŸ“Š Change Analysis\n\n` +
              `This PR affects the following areas:\n\n` +
              changedAreas.map(area => `- âœ… **${area}**`).join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ==================== Bundle å¤§å°åˆ†æ ====================
  bundle-size:
    name: ğŸ“¦ Bundle Size Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ“Š Analyze bundle size
        run: |
          npx expo export --platform android --output-dir dist-android
          BUNDLE_SIZE=$(du -sh dist-android | cut -f1)
          echo "ğŸ“¦ Bundle size: $BUNDLE_SIZE"
          echo "BUNDLE_SIZE=$BUNDLE_SIZE" >> $GITHUB_ENV
        continue-on-error: true

      - name: ğŸ’¬ Comment bundle size
        uses: actions/github-script@v7
        if: always()
        env:
          BUNDLE_SIZE: ${{ env.BUNDLE_SIZE }}
        with:
          script: |
            const bundleSize = process.env.BUNDLE_SIZE;
            if (!bundleSize) {
              console.log('Bundle size not available');
              return;
            }

            const comment = `## ğŸ“¦ Bundle Size Report\n\n` +
              `**Android Bundle**: ${bundleSize}\n\n` +
              `âš ï¸ æ³¨æ„: å¦‚æœ bundle å¤§å°æ˜¾è‘—å¢åŠ ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å¼•å…¥äº†ä¸å¿…è¦çš„ä¾èµ–ã€‚`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ==================== PR çŠ¶æ€æ€»ç»“ ====================
  pr-summary:
    name: ğŸ“‹ PR Summary
    runs-on: ubuntu-latest
    needs: [pr-info, change-analysis, bundle-size]
    if: always()

    steps:
      - name: ğŸ“Š Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## ğŸ¯ PR Checks Summary\n\n` +
              `### Status:\n` +
              `- ğŸ“‹ PR Info: ${{ needs.pr-info.result }}\n` +
              `- ğŸ“Š Change Analysis: ${{ needs.change-analysis.result }}\n` +
              `- ğŸ“¦ Bundle Size: ${{ needs.bundle-size.result }}\n\n` +
              `> â„¹ï¸ ä»£ç è´¨é‡ã€å•å…ƒæµ‹è¯•å’Œæ„å»ºæ£€æŸ¥åœ¨ä¸» CI å·¥ä½œæµä¸­è¿è¡Œã€‚\n` +
              `> è¯·æŸ¥çœ‹ [CI å·¥ä½œæµ](../actions/workflows/ci.yml) äº†è§£è¯¦æƒ…ã€‚`;

            console.log(summary);
